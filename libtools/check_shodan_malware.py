# encoding=utf-8
import pymongo


def check_malware():
    """
    shodan解析到product包含trojan，可以通过此处判断IP-domain为高可信域名，这个函数用于找出所有这样的IP和域名
    :return:
    """
    domain = pymongo.MongoClient('34.209.173.8', 27017)['virustotal']['domain']
    shodan_scan = pymongo.MongoClient('localhost', 27017)['virustotal']['shodan_scan']
    results = []

    data = shodan_scan.find({'banner.product': {'$regex': r'.*trojan'}})
    for d in data:
        ip = d.get('ip_str')
        domains = domain.distinct('original_domain', {'iplist.ip': ip})
        results.append({'ip': ip, 'domains': domains})
    for i in results:
        print 'ip: %s' % i.get('ip')
        for d in i.get('domains'):
            print '\t%s' % d


if __name__ == '__main__':
    check_malware()